#!/bin/bash

if [ "$1" == "" ]; then
        cluster=test
else
        cluster=$1
fi

sudo=$(if [ "$(whoami)" != root ]; then echo sudo; else echo ""; fi )

curdir=$(pwd)
eval "$sudo rm \"$curdir/$cluster/status/*\" -rf "
eval "$sudo mkdir -p \"$curdir/$cluster/status\""
ls "$curdir/$cluster"
hostfile=$(which dexxhosts)

#dhosts=$(cat $hostfile|awk "(\$6 == \"$cluster\") && (\$4 != \"-\") {print \$4}"|sort|uniq|sed '/^$/d')
# (wrong debug way) 2015.12.6 Anibal: get ip needs status of docker host! (remove not equal condition)
#dhosts=$(cat $hostfile|awk "(\$6 == \"$cluster\") {print \$4}"|sort|uniq|sed '/^$/d')
# So i removed both (\$4 != \"-\") below...


dhosts=$(cat $hostfile|awk "(\$6 == \"$cluster\") {print \$4}"|sort|uniq|sed '/^$/d')
echo -e "start init hosts\n$dhosts"

if [ "$dhosts" == "" ]; then 
	echo no docker host records
else
	#echo "1: $(pwd)"
	for fnm in $dhosts; do
		#echo "2: $curdir/$cluster"
		cd "$curdir/$cluster"
		#echo "3: $(pwd)"
		#echo $fnm
		eval "$sudo mkdir -p \"$fnm\""
		cd "./$fnm"
		#echo $(pwd)
		#chosts=$(cat $hostfile|awk "(\$4 == \"$fnm\") && (\$6 == \"$cluster\") && (\$4 != \"-\") {print \$2}"|sort|uniq|sed '/^$/d')
		chosts=$(cat $hostfile|awk "(\$4 == \"$fnm\") && (\$6 == \"$cluster\") && (\$3 != \"i\") {print \$2}"|sort|uniq|sed '/^$/d')
		for cnm in $chosts; do
			echo init $cnm...
			eval "$sudo mkdir -p \"$cnm\""
			if [ ! -e "$curdir/$cluster/status/$cnm.status" ]; then
				eval "$sudo bash -c \"echo \\\"Initialized\\\" > \\\"$curdir/$cluster/status/$cnm.status\\\"\""
			fi
			#if [ ! -e "$curdir/$cluster/$fnm/$cnm/
		done
	done
fi
