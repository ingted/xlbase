#!/bin/bash

if [ "$1" == "" ]; then
	echo "XL role is required!"
	exit 999
else
	role=$1
fi

if [ "$6" == "" ]; then
        
 	echo "cluster is required! sets to \"test\""
	cluster=test
else
        cluster=$6
fi


echo $(date +"%T") \[\| xl-init \|\] BEGINNING...



specified_cnm=$3
specified_nid=$4
specified_sm=$5



hosts=$(./mgmt-xl-get-host-by-role "$role" $cluster)

for host in $hosts; do
	nid=$(./mgmt-xl-get-node-id "$host" $cluster)
	if [ "$specified_nid" == "-" ] || [ "$specified_nid" == "$nid" ]; then
		sm=$(./mgmt-xl-get-m-or-s "$host"  $cluster)
		if [ "$specified_sm" == "-" ] || [ "$specified_sm" == "$sm" ]; then
			if [ "$specified_cnm" == "-" ] || [ "$specified_cnm" == "$host" ]; then

				conf=$(./mgmt-xl-get-confname "$host" $cluster|awk 'NR>2 {print $1","$2","$3}'|sort|uniq)
				if [ "$conf" == "invalid specified host!" ]; then
					echo "invalid specified host! mgmt-xl-init failed!"
					continue
				fi
				dir=$(echo "$conf"|awk '{split($0, a, ","); print a[1]}'|sort|uniq)
				
				echo $(date +"%T") \[\| xl-init \|\] @$host $1 $dir
				util-bpx "$host" $2 cluster-xl-init.ps1 $host $1 $dir
				
				#echo $conf
				for i in $conf; do
					echo $i
					confpath=$(echo "$conf"|awk '{split($0, a, ","); print a[2]}'|sort|uniq)
					
					echo $(date +"%T") \[\| xl-conf \|\] @$host $confpath
					#config=
					
					#util-px "$1" cluster-xl-conf.ps1 $host $1 $dir $confpath $config
				done
			fi
		fi
	fi
done
