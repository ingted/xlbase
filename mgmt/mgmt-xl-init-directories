#!/bin/bash


if [ "$1" == "" ]; then
	echo "Container name is required!"
	exit 999
else
	nm=$1
fi

if [ "$2" == "" ]; then
	echo "Cluster is required!."
	exit 999
else
	cluster=$2
fi

if [ "$4" == "" ]; then
	echo "pgxl version is required!."
	exit 999
else
	pgver=$4
fi


if [ "$3" == "" ]; then
	echo "PGUSER is required! Use postgres."
	pgu=postgres
else
	pgu=$3
fi



hostsitem=$(./mgmt-xl-get-host-by-cluster $cluster)
#echo "$hostsitem"
dirdata=$(for hii in $hostsitem; do hhii=(${hii//,/ }); ./mgmt-xl-get-confname ${hhii[1]} $pgver $cluster|awk 'NR>2 {print $1}'; done)

#echo "$dirdata"

db64=$(echo "$dirdata"|base64)
echo $db64

echo $(date +"%T") \[\| cluster-dirs \|\]
util-px "$nm" cluster-dirs.ps1 $db64

util-px "$nm" if\(\(dir /postgres\) -eq \$null\){\"init xl dirs failed\!\"}


echo $(date +"%T") \[\| service-account \|\]
util-dx "$nm" ./cluster-service-account.sh -n $pgu -p "/\'],lp123"

echo $(date +"%T") \[\| service-account-permissions \|\]
util-dx "$nm" ./cluster-service-account-permissions.sh -n $pgu

echo $(date +"%T") \[\| init-directories done \|\]
